<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Opname Material</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üìã Stock Opname Material</h1>
            <p class="text-gray-600">Sistem manajemen stock opname material dengan import Excel</p>
        </div>

        <!-- Import Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üìÅ Import Master Data</h2>
            <div class="flex flex-col sm:flex-row gap-4 items-start">
                <div class="flex-1">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="text-xs text-gray-500 mt-1">Format Excel: Kode Material | Nama Material | Satuan | Stock di Sistem</p>
                </div>
                <button onclick="importExcel()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    Import Excel
                </button>
            </div>
        </div>

        <!-- Input Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">‚ûï Input Stock Opname</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kode Material</label>
                    <input type="number" id="kodeMaterial" placeholder="Masukkan kode..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           oninput="refreshMaterialInfo()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Material</label>
                    <input type="text" id="namaMaterial" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Satuan</label>
                    <input type="text" id="satuan" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Stock di Sistem</label>
                    <input type="number" id="stockSistem" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Qty Aktual</label>
                    <input type="number" id="qtyAktual" placeholder="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <div class="mt-4">
                <button onclick="addStockOpname()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    Tambah Data
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-wrap gap-4">
                <button onclick="downloadExcel()" 
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                    üì• Download Excel
                </button>
                <button onclick="deleteSelected()" 
                        class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                    üóëÔ∏è Hapus Terpilih
                </button>
                <button onclick="clearAllData()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                    üóëÔ∏è Hapus Semua
                </button>
                <button onclick="clearAllStorage()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                    üóÇÔ∏è Reset Aplikasi
                </button>
            </div>
        </div>

        <!-- Table Section -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="p-6 border-b">
                <h2 class="text-xl font-semibold text-gray-800">üìä Data Stock Opname</h2>
            </div>
            <div class="table-container">
                <table class="w-full">
                    <thead class="bg-gray-50 sticky-header">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="rounded">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Material</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Satuan</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock di Sistem</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty Aktual</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Selisih</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="stockOpnameTable" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                Belum ada data stock opname. Import master data Excel terlebih dahulu.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let masterData = [];
        let stockOpnameData = [];

        // Load data from localStorage on page load
        function loadDataFromStorage() {
            try {
                const savedMasterData = localStorage.getItem('stockOpname_masterData');
                const savedStockData = localStorage.getItem('stockOpname_stockData');
                
                if (savedMasterData) {
                    masterData = JSON.parse(savedMasterData);
                    console.log(`Loaded ${masterData.length} master data from storage`);
                }
                
                if (savedStockData) {
                    stockOpnameData = JSON.parse(savedStockData);
                    console.log(`Loaded ${stockOpnameData.length} stock opname data from storage`);
                    updateTable();
            saveDataToStorage();
                }
            } catch (error) {
                console.error('Error loading data from storage:', error);
            }
        }

        // Save data to localStorage
        function saveDataToStorage() {
            try {
                localStorage.setItem('stockOpname_masterData', JSON.stringify(masterData));
                localStorage.setItem('stockOpname_stockData', JSON.stringify(stockOpnameData));
            } catch (error) {
                console.error('Error saving data to storage:', error);
            }
        }

        // Import Excel function
        function importExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Pilih file Excel terlebih dahulu!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    // Skip header row and process data
                    masterData = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row[0]) { // Check if kode material exists
                            masterData.push({
                                kode: String(row[0]),
                                nama: row[1] || '',
                                satuan: row[2] || '',
                                stockSistem: Number(row[3]) || 0
                            });
                        }
                    }
                    
                    saveDataToStorage();
                    alert(`Berhasil import ${masterData.length} data material!`);
                    console.log('Master data loaded:', masterData);
                } catch (error) {
                    alert('Error membaca file Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Refresh material info based on kode
        function refreshMaterialInfo() {
            const kode = document.getElementById('kodeMaterial').value;
            const material = masterData.find(item => item.kode === kode);
            
            if (material) {
                document.getElementById('namaMaterial').value = material.nama;
                document.getElementById('stockSistem').value = material.stockSistem;
                document.getElementById('satuan').value = material.satuan;
            } else {
                document.getElementById('namaMaterial').value = '';
                document.getElementById('stockSistem').value = '';
                document.getElementById('satuan').value = '';
            }
        }

        // Add stock opname data
        function addStockOpname() {
            const kode = document.getElementById('kodeMaterial').value;
            const nama = document.getElementById('namaMaterial').value;
            const stockSistem = Number(document.getElementById('stockSistem').value);
            const satuan = document.getElementById('satuan').value;
            const qtyAktual = Number(document.getElementById('qtyAktual').value);

            if (!kode || !nama) {
                alert('Kode material tidak ditemukan di master data!');
                return;
            }

            if (qtyAktual === '' || isNaN(qtyAktual)) {
                alert('Masukkan Qty Aktual yang valid!');
                return;
            }

            // Check if already exists
            const existingIndex = stockOpnameData.findIndex(item => item.kode === kode);
            if (existingIndex !== -1) {
                if (confirm('Kode material sudah ada. Update data?')) {
                    stockOpnameData[existingIndex].qtyAktual = qtyAktual;
                    stockOpnameData[existingIndex].selisih = qtyAktual - stockSistem;
                }
            } else {
                stockOpnameData.push({
                    kode,
                    nama,
                    stockSistem,
                    qtyAktual,
                    selisih: qtyAktual - stockSistem,
                    satuan
                });
            }

            // Clear form
            document.getElementById('kodeMaterial').value = '';
            document.getElementById('namaMaterial').value = '';
            document.getElementById('stockSistem').value = '';
            document.getElementById('satuan').value = '';
            document.getElementById('qtyAktual').value = '';

            updateTable();
            saveDataToStorage();
        }

        // Update table display
        function updateTable() {
            const tbody = document.getElementById('stockOpnameTable');
            
            if (stockOpnameData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            Belum ada data stock opname.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = stockOpnameData.map((item, index) => {
                const statusClass = item.selisih === 0 ? 'bg-green-100 text-green-800' : 
                                  item.selisih > 0 ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800';
                const statusText = item.selisih === 0 ? 'Sesuai' : 
                                 item.selisih > 0 ? 'Lebih' : 'Kurang';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4">
                            <input type="checkbox" class="row-checkbox rounded" data-index="${index}">
                        </td>
                        <td class="px-4 py-4 text-sm font-medium text-gray-900">${item.kode}</td>
                        <td class="px-4 py-4 text-sm text-gray-900">${item.nama}</td>
                        <td class="px-4 py-4 text-sm text-gray-900">${item.satuan}</td>
                        <td class="px-4 py-4 text-sm text-gray-900">${item.stockSistem.toLocaleString()}</td>
                        <td class="px-4 py-4 text-sm text-gray-900">${item.qtyAktual.toLocaleString()}</td>
                        <td class="px-4 py-4 text-sm font-medium ${item.selisih >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${item.selisih > 0 ? '+' : ''}${item.selisih.toLocaleString()}
                        </td>
                        <td class="px-4 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Toggle select all
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        // Delete selected rows
        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Pilih data yang akan dihapus!');
                return;
            }

            if (confirm(`Hapus ${checkboxes.length} data terpilih?`)) {
                const indicesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
                indicesToDelete.sort((a, b) => b - a); // Sort descending to avoid index issues
                
                indicesToDelete.forEach(index => {
                    stockOpnameData.splice(index, 1);
                });

                document.getElementById('selectAll').checked = false;
                updateTable();
                saveDataToStorage();
            }
        }

        // Clear all data
        function clearAllData() {
            if (stockOpnameData.length === 0) {
                alert('Tidak ada data untuk dihapus!');
                return;
            }

            if (confirm('Hapus semua data stock opname?')) {
                stockOpnameData = [];
                document.getElementById('selectAll').checked = false;
                updateTable();
                saveDataToStorage();
            }
        }

        // Clear all storage (reset application)
        function clearAllStorage() {
            if (confirm('Reset aplikasi akan menghapus SEMUA data termasuk master data dan stock opname. Lanjutkan?')) {
                localStorage.removeItem('stockOpname_masterData');
                localStorage.removeItem('stockOpname_stockData');
                masterData = [];
                stockOpnameData = [];
                document.getElementById('selectAll').checked = false;
                updateTable();
                alert('Aplikasi berhasil direset!');
            }
        }

        // Download Excel
        function downloadExcel() {
            if (stockOpnameData.length === 0) {
                alert('Tidak ada data untuk didownload!');
                return;
            }

            const ws_data = [
                ['Kode Material', 'Nama Material', 'Satuan', 'Stock di Sistem', 'Qty Aktual', 'Selisih', 'Status']
            ];

            stockOpnameData.forEach(item => {
                const status = item.selisih === 0 ? 'Sesuai' : 
                              item.selisih > 0 ? 'Lebih' : 'Kurang';
                ws_data.push([
                    item.kode,
                    item.nama,
                    item.satuan,
                    item.stockSistem,
                    item.qtyAktual,
                    item.selisih,
                    status
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Stock Opname');

            const fileName = `Stock_Opname_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Allow only numbers in kode material input
        document.getElementById('kodeMaterial').addEventListener('keypress', function(e) {
            if (!/[0-9]/.test(e.key) && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'Tab') {
                e.preventDefault();
            }
        });

        // Enter key to add data
        document.getElementById('qtyAktual').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addStockOpname();
            }
        });

        // Load data when page loads
        window.addEventListener('load', function() {
            loadDataFromStorage();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindo